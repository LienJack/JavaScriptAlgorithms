<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AVL(平衡树)</title>
</head>
<body>
<script>
    class Node {
        constructor(key, value) {
            this.key = key;
            this.value = value;
            this.left = null;
            this.right = null;
            this.height = 1;
        }
    }

    class AVLTree {
        constructor() {
            this.root = null;
            this.size = 0;
        }

        add(key, value) {
            this.root = this._add(this.root, key, value)
        }

        _add(node, key, value) {
            if (node === null) {
                this.size++;
                return new Node(key, value)
            }

            if (value < node.value) {
                node.left = this._add(node.left, key, value)
            } else if (value > node.value) {
                node.right = this._add(node.right, key, value)
            } else {
                node.key = key;
                node.value = value
            }
            node.height = 1 + Math.max(this.getHeight(node.left), this.getHeight(node.right));

            //计算平衡因子
            let balanceFactor = this.getBalanceFactor(node);
            if (Math.abs(balanceFactor) > 1) {
                console.log(`unbalance: ${Math.abs(balanceFactor)}`)
            }

            return node
        }

        isBST() {
            let keys = [];
            this.inOrder(this.root, keys);
            for (let i = 1; i < keys.length; i++) {
                if (keys[i - 1] > keys[i]) return false
            }
            return true
        }

        isBalanced() {
            return this._isBalanced(this.root)
        }

        _isBalanced(node) {
            if (!node) return true;

            let balanceFactor = this.getBalanceFactor(node);
            if (Math.abs(balanceFactor) > 1) {
                return false
            }
            return this._isBalanced(node.left) && this._isBalanced(node.right)
        }

        //获取节点平衡因子
        getBalanceFactor(node) {
            if (node === null) return 0;

            return this.getHeight(node.left) - this.getHeight(node.right)
        }

        getHeight(node) {
            if (node === null) return 0;

            return node.height;
        }

        getSize() {
            return this.size
        }

        inOrder(node, keys) {
            if (!node) return null;

            let pre;
            while (node) {
                if (!node.left) {
                    keys.push(node.key);
                    node = node.right
                } else {
                    pre = node.left;
                    while (pre.right && pre.right !== node) {
                        pre = pre.right
                    }
                    if (!pre.right) {
                        pre.right = node;
                        node = node.left
                    } else {
                        keys.push(node)
                        node = node.right
                    }
                }
            }
        }
    }
</script>
</body>
</html>